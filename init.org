#+TITLE: Emacs configuration file
#+AUTHOR: Matthias Schmitt
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+PROPERTY: header-args:elisp :tangle yes
#+PROPERTY: header-args :comments both

This is my emacs configuration file in literate style as an org mode file.

* Preface

We automatically reload the configuration after changes to the 'init.org' file.

** Tangle

#+BEGIN_SRC emacs-lisp
  (setq user-emacs-directory "~/.emacs.d/")
#+END_SRC

TODO why are there use-package errors when using byte-compile-file

#+BEGIN_SRC emacs-lisp
  (defun tangle-init ()
    "If the current buffer is 'init.org' the code-blocks are
    tangled, and the tangled file is compiled."
    (when (equal (buffer-file-name)
		 (expand-file-name "init.org" user-emacs-directory))
      ;; Avoid running hooks when tangling.
      (let ((prog-mode-hook nil))
	(org-babel-tangle)
	;; (byte-compile-file (expand-file-name "init.el" user-emacs-directory))
	)))

  (add-hook 'after-save-hook 'tangle-init)
#+END_SRC

* Initial Stuff

#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-message t)
  (setq initial-scratch-message "")
#+END_SRC

** Init Time

#+begin_src emacs-lisp
  (add-hook 'emacs-startup-hook
	    (lambda ()
	      (message "Emacs ready in %s with %d garbage collections."
		       (format "%.2f seconds"
			       (float-time
				(time-subtract after-init-time before-init-time)))
		       gcs-done)))
#+end_src

** Garbage Collection

Disabling GC (by setting `gc-cons-threshold' to a very large value)
during startup is said to improve startup time by reducing the number of GC runs.
After startup reset it to reasonable value

#+BEGIN_SRC emacs-lisp
  ;; (message (format "%s - %s" gc-cons-threshold gc-cons-percentage))
  (setq garbage-collection-messages t)

  (setq gc-cons-threshold 402653184) ;;gc-cons-percentage 0.6)
  (add-hook 'after-init-hook (lambda ()
			       (run-with-idle-timer
				  10
				  nil
				  (lambda ()
				    (interactive)
				    (message "Reset gc threshold after init and idle")
				    (setq gc-cons-threshold 50000000)))))
  (add-hook 'focus-out-hook 'garbage-collect)
#+END_SRC

** Package management & straight.el

Bootstrap straight.el

#+BEGIN_SRC emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
	 (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
	(bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
	  (url-retrieve-synchronously
	   "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	   'silent 'inhibit-cookies)
	(goto-char (point-max))
	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+END_SRC

Use ~straight.el~ together with ~use-package~

Package `use-package' provides a handy macro by the same name which
is essentially a wrapper around `with-eval-after-load' with a lot
of handy syntactic sugar and useful features.

#+BEGIN_SRC emacs-lisp
  (eval-when-compile
    (straight-use-package 'use-package))

  ;; Tell `use-package' to always load features lazily unless told
  ;; otherwise. It's nicer to have this kind of thing be deterministic:
  ;; if `:demand' is present, the loading is eager; otherwise, the
  ;; loading is lazy. See
  ;; https://github.com/jwiegley/use-package#notes-about-lazy-loading.
  (setq use-package-always-defer t)

  ;; When configuring a feature with `use-package', also tell
  ;; straight.el to install a package of the same name, unless otherwise
  ;; specified using the `:straight' keyword.
  (setq straight-use-package-by-default t)

  (setq use-package-compute-statistics t)
  (setq use-package-verbose t)
#+END_SRC

** Custom

Don't clobber the init.el file
use a own file for emacs custom definition

#+BEGIN_SRC emacs-lisp
  (setq custom-file (expand-file-name "emacs-custom.el" user-emacs-directory))
  (load custom-file)
#+END_SRC

** Basic packages

#+BEGIN_SRC emacs-lisp
  (use-package diminish
    :demand)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (use-package general
    :demand
    :config
    (general-evil-setup t)

    (defconst my-menu-key "SPC")
    (defconst my-non-normal-menu-key "M-SPC")
    (general-create-definer my-menu-def
      :states '(normal insert emacs)
      :keymaps 'override
      :prefix my-menu-key
      :non-normal-prefix my-non-normal-menu-key)
    (my-menu-def
      "?" '(general-describe-keybindings :which-key "show bindings"))

    (defconst my-leader-key ",")
    (defconst my-non-normal-leader-key "M-,")
    (general-create-definer my-leader-def
      :states '(normal)
      :keymaps 'override
      :prefix my-leader-key
      :non-normal-prefix my-non-normal-leader-key)
    )
#+END_SRC

#+BEGIN_SRC emacs-lisp
    (use-package which-key
      :demand
      :general (my-menu-def
		 "H K" 'which-key-show-keymap
		 "H T" 'which-key-show-top-level)
      :diminish which-key-mode
      :config (which-key-mode))
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (use-package epkg
    :defer t
    ;; on func epkg-list-packages)
    )
#+END_SRC

https://github.com/purcell/exec-path-from-shell

#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :demand
    :config (exec-path-from-shell-initialize))
#+end_src

* Saving
** Backup

#+BEGIN_SRC emacs-lisp
  (defvar --backup-directory (expand-file-name ".cache/backups" user-emacs-directory))
  (if (not (file-exists-p --backup-directory))
      (make-directory --backup-directory t))
  (setq backup-directory-alist `(("." . ,--backup-directory)))
  (setq make-backup-files t               ; backup of a file the first time it is saved.
	backup-by-copying t               ; don't clobber symlinks
	version-control t                 ; version numbers for backup files
	delete-old-versions t             ; delete excess backup files silently
	;; delete-by-moving-to-trash t
	kept-old-versions 6               ; oldest versions to keep when a new numbered backup is made (default: 2)
	kept-new-versions 9               ; newest versions to keep when a new numbered backup is made (default: 2)
	auto-save-default t               ; auto-save every buffer that visits a file
	auto-save-timeout 20              ; number of seconds idle time before auto-save (default: 30)
	auto-save-interval 200            ; number of keystrokes between auto-saves (default: 300)
	)
#+END_SRC

** Undo history

#+BEGIN_SRC emacs-lisp
  (defvar --undo-directory (expand-file-name ".cache/undo" user-emacs-directory))
  (if (not (file-exists-p --undo-directory))
      (make-directory --undo-directory t))
  (setq undo-tree-auto-save-history t)
  (setq undo-tree-history-directory-alist `(("." . ,--undo-directory)))
#+END_SRC

** File history

#+begin_src emacs-lisp
  (save-place-mode 1) ;; save last cursor position
  (savehist-mode 1) ;; save minibuffer history
#+end_src

*** recentf
#+begin_src emacs-lisp
  (recentf-mode 1)
  (setq recentf-max-menu-items 200 ;; MRU configs
	recentf-max-saved-items 200
	recentf-exclude '("recentf" "autoload" "emacs-customizations.el"))
#+end_src

** Lockfile
#+begin_src emacs-lisp
  (setq create-lockfiles nil)
#+end_src

* Navigation
** Buffer & Window menu

#+BEGIN_SRC emacs-lisp
  (my-menu-def
    "TAB" '(mode-line-other-buffer :which-key "last-buffer")
    "M-TAB" '((lambda () (interactive (switch-to-buffer-other-window (other-buffer))))
	      :which-key "last-buffer-other-window")

    "B" '(:ignore t :which-key "Buffer")
    "B m" '((lambda () (interactive) (switch-to-buffer "*Messages*"))
	    :which-key "messages")
    "B M" '((lambda () (interactive) (switch-to-buffer-other-window "*Messages*"))
	    :which-key "messages-in-other")
    "B s" '((lambda () (interactive) (switch-to-buffer "*scratch*"))
	    :which-key "scratch")
    "B S" '((lambda () (interactive) (switch-to-buffer-other-window "*scratch*"))
	    :which-key "scratch-in-other")
    "B w" '((lambda () (interactive) (switch-to-buffer "*Warnings*"))
	    :which-key "warnings")
    "B W" '((lambda () (interactive) (switch-to-buffer-other-window "*Warnings*"))
	    :which-key "warnings-in-other")
    "B d" 'evil-delete-buffer
    "B r" 'revert-buffer
    "B q" 'quit-window
    "B k" 'kill-current-buffer

    "w" 'other-window
    "W" '(:ignore t :which-key "Window")
    "W d" 'delete-window
    "W o" 'delete-other-windows)
#+end_src

** winner
   undo and redo for window operations

#+begin_src emacs-lisp
  (use-package winner
    :demand
    :general (my-menu-def
	       "W u" 'winner-undo
	       "W r" 'winner-redo)
    :config (winner-mode 1))
#+end_src

** abo-abo
[[http://oremacs.com/swiper/][ivy & swiper manual]]
*** ivy

#+begin_src emacs-lisp
  (use-package ivy
    :demand
    :diminish ivy-mode
    :general
    (my-menu-def
      "b" '(:ignore t :which-key "Buffer")
      "b" (general-key-dispatch 'ivy-switch-buffer
	    :timeout .33
	    "m" (lambda () (interactive) (switch-to-buffer "*Messages*"))
	    "s" (lambda () (interactive) (switch-to-buffer "*scratch*"))
	    "w" (lambda () (interactive) (switch-to-buffer "*Warnings*"))
	    "b" 'ivy-switch-buffer
	    "d" 'evil-delete-buffer
	    "q" 'quit-window
	    ))

    (:keymaps 'ivy-minibuffer-map
	      "C-l" 'ivy-alt-done
	      "C-h" 'ivy-backward-delete-char
	      "<escape>" 'minibuffer-keyboard-quit
	      "C-SPC" 'nil
	      "C-TAB" 'ivy-insert-current)

    (:keymaps 'ivy-occur-grep-mode-map
	      "SPC" nil)

    :config
    (ivy-mode 1)
    (setq ivy-use-virtual-buffers t)
    (setq ivy-count-format "(%d/%d) ")
    (setq enable-recursive-minibuffers t)
    (setq ivy-extra-directories nil)
    (setq ivy-wrap t))

  (use-package ivy-hydra
    :defer 15
    :after (ivy hydra)
    :commands (hydra-ivy/body))

  (use-package prescient
    :demand
    :after ivy
    :config (setq prescient-filter-method 'literal+initialism))

  (use-package ivy-prescient
    :demand
    :after (prescient ivy)
    :config (ivy-prescient-mode t))

  (use-package ivy-rich
    :demand
    :after (ivy counsel)
    :config
    (ivy-rich-mode 1)
    (setq ivy-rich-parse-remote-buffer nil))
#+end_src

*** counsel

#+begin_src emacs-lisp
  (use-package counsel
    :demand
    :diminish counsel-mode
    :general (my-menu-def
	       "f" '(:ignore t :which-key "File")
	       "f" 'counsel-find-file
	       "F" '(:ignore t :which-key "File")
	       "F r" '(counsel-recentf :which-key "recent")
	       "r" '(counsel-recentf :which-key "recent")
	       "SPC" '(counsel-M-x :which-key "M-x"))
    (:keymap global-map
	     "C-c f" 'counsel-find-file
	     "C-c r" 'counsel-recentf
	     "C-x C-r" 'counsel-recentf)
    :config (counsel-mode))

  (use-package counsel-tramp
    :defer 15
    :after counsel
    :general (my-menu-def
	       "F t" 'counsel-tramp)
    :config (setq tramp-default-method "ssh"))
#+end_src

*** swiper

#+begin_src emacs-lisp
  (use-package swiper
    :defer 15
    :general (:states 'normal
		      "C-s" 'swiper))
#+end_src

*** avy

#+begin_src emacs-lisp
  (use-package avy
    :defer 15
    :commands (avy-goto-char-2 avy-goto-char-timer avy-goto-line)
    :general (:states 'normal
		      "g t" 'avy-goto-char-2
		      ))
#+end_src

*** hydra

#+begin_src emacs-lisp
  (use-package hydra
    :defer 15)
#+end_src

** Symbol

#+begin_src emacs-lisp
  (use-package symbol-overlay
    :defer 15
    :general (my-menu-def
	       "s" '(:ignore t :which-key "Symbol")
	       "s" (general-key-dispatch 'symbol-overlay-put
		     :timeout .33
		     "n" 'symbol-overlay-jump-next
		     "p" 'symbol-overlay-jump-previous
		     "d" 'symbol-overlay-remove-all
		     "r" 'symbol-overlay-rename
		     )

	       "S" '(:ignore t :which-key "Symbol")
	       "S s" 'symbol-overlay-mode
	       "S n" 'symbol-overlay-jump-next
	       "S p" 'symbol-overlay-jump-prev
	       "S d" 'symbol-overlay-remove-all
	       "S r" 'symbol-overlay-rename
	       ))
#+end_src

** projectile

TODO [[https://github.com/technomancy/find-file-in-project][find-file-in-project]] vs projectile

#+BEGIN_SRC emacs-lisp

  (use-package projectile
    :demand
    :diminish (projectile-mode)
    :general (my-menu-def
		      "p" 'projectile-find-file
		      "P" '(nil :which-key "Project")
		      "P p" 'projectile-switch-project
		      "P c" 'projectile-compile-project
		      "P r" 'projectile-run-project
		      "P t" 'projectile-test-project)
    :config
    (projectile-mode +1)
    (setq projectile-completion-system 'ivy)
    (setq projectile-generic-command "fd -H --ignore-file .projectile -t f -0")
    ;; (setq projectile-indexing-method 'turbo-alien)
    (setq projectile-project-search-path '("~/proj/")))

  (use-package counsel-projectile
    :demand
    :after (counsel projectile)
    :general (my-menu-def
		      "p" 'counsel-projectile
		      "P p" 'counsel-projectile-switch-project
		      "/" '(counsel-projectile-rg :which-key "search proj"))
    :config (counsel-projectile-mode))
#+END_SRC

** wgrep

#+BEGIN_SRC emacs-lisp
(use-package wgrep
  :defer 5)
#+END_SRC

* Evil
** evil-mode

https://github.com/emacs-evil/evil-collection

https://github.com/noctuid/evil-guide

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :demand
    :diminish undo-tree-mode
    :general (:states 'normal
		      "U" 'undo-tree-visualize)
    :config
    (global-undo-tree-mode +1))

  (use-package evil
    :demand
    :init
    (setq evil-want-C-w-delete nil)
    (setq evil-want-C-w-in-emacs-state t)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-Y-yank-to-eol t)
    :config
    (evil-mode 1)
    (cl-loop for (mode . state) in '((haskell-interactive-mode . emacs)
				     (haskell-error-mode . emacs)
				     (term-mode . emacs)
				     (messages-mode . normal)
				     (compilation-mode . motion)
				     )
	     do (evil-set-initial-state mode state))
    ;; (cl-loop for map in '(helpful-mode-map
    ;;			  )
    ;;	     do (evil-make-overriding-map map))
    (evil-set-command-property 'evil-yank :move-point t)
    (setq evil-echo-state nil)
    (setq evil-ex-substitute-global t)
    (setq evil-vsplit-window-right t)
    )
#+END_SRC

** Vim goodies

Folding

#+BEGIN_SRC emacs-lisp
  (add-hook 'prog-mode 'hs-minor-mode)
#+END_SRC

Equivalent of ~nnoremap n nzz~

#+BEGIN_SRC emacs-lisp
  (defun my-center-line (&rest _)
    (evil-scroll-line-to-center nil))

  (advice-add 'evil-search-next :after #'my-center-line)
#+END_SRC

Use < in visual mode to continuously shift selection
#+begin_src emacs-lisp
  (defun maschm/visual-restore ()
    "Restore visual selection."
    (interactive)
    (evil-normal-state)
    (evil-visual-restore))

  (advice-add 'evil-shift-right :after #'maschm/visual-restore)
#+end_src

** Evil packages

#+BEGIN_SRC emacs-lisp
  (use-package evil-commentary
    :demand
    :diminish (evil-commentary-mode)
    :config (evil-commentary-mode))

  (use-package evil-surround
    :demand
    :config (global-evil-surround-mode 1))

  (use-package evil-matchit
    :demand
    :config (global-evil-matchit-mode 1))

  (use-package smartparens
    :demand)

  (use-package evil-smartparens
    :demand
    :after (evil smartparens)
    :config (add-hook 'smartparens-enabled-hook #'evil-smartparens-mode))

  (use-package evil-mc
    :demand
    :diminish emc
    ;; :config
    ;; (global-evil-mc-mode 1)
    ;; (add-hook 'magit-mode-hook #'evil-mc-mode -1))
    )

  (use-package evil-visualstar
    :demand
    :config (global-evil-visualstar-mode))

  (use-package evil-lion
    :bind (:map evil-normal-state-map
		("g l " . evil-lion-left)
		("g L " . evil-lion-right)
		:map evil-visual-state-map
		("g l " . evil-lion-left)
		("g L " . evil-lion-right)))
#+END_SRC

* Org
** org-mode

#+BEGIN_SRC emacs-lisp
  (use-package org
    :defer 60
    :general (my-menu-def
	       "o" '(:ignore t :which-key "org-outline")
	       "o" (general-key-dispatch 'counsel-outline
		     :timeout .33
		     "a" 'org-agenda
		     "c" 'org-capture)

	       "O" '(nil :which-key "org")
	       "O a" 'org-agenda
	       "O c" 'org-capture
	       "O l" 'org-insert-link
	       "O L" 'org-store-link)

    (:keymap global-map
	     "C-c c" 'org-capture
	     "C-c a" 'org-agenda
	     "C-c l" 'org-store-link)
    :config
    (add-hook 'org-mode-hook 'flyspell-mode)
    (setq org-directory "~/org/")
    (setq org-return-follows-link t)
    (setq org-startup-folded t)
    (setq org-pretty-entities t)

    (setq org-default-notes-file (expand-file-name "inbox.org" org-directory))
    (setq org-agenda-files '("~/org/inbox.org"
			     "~/org/gtd.org"
			     "~/org/tickler.org"))
    (setq org-todo-keywords '((sequence "TODO(t)" "WAITING(w)" "|" "DONE(d)" "CANCELLED(c)")))
    (setq org-capture-templates '(("t" "Todo [inbox]" entry
				   (file+headline "~/org/inbox.org" "Tasks")
				   "* TODO %i%?")
				  ("m" "Mail Todo [inbox]" entry
				   (file+headline "~/org/inbox.org" "Tasks")
				   "* TODO %i%?\n%a\n")
				  ("T" "Tickler" entry
				   (file+headline "~/org/tickler.org" "Tickler")
				   "* %i%? \n %U")))
    (setq org-refile-targets '(("~/org/gtd.org" :maxlevel . 3)
			       ("~/org/someday.org" :level . 1)
			       ("~/org/tickler.org" :maxlevel . 2)))
    (setq org-tag-alist '(("@home" . "h") ("@uni" . "u") ("@work" . "w")))
    (setq org-refile-use-outline-path 'file)
    (setq org-outline-path-complete-in-steps nil)

    (push '("se" . "src emacs-lisp") org-structure-template-alist)
    (push '("sp" . "src python") org-structure-template-alist)
    (org-babel-do-load-languages 'org-babel-load-languages
				 '((shell . t))))

  (use-package evil-org
    :demand
    :after (evil org)
    :config
    (add-hook 'org-mode-hook 'evil-org-mode)
    (add-hook 'evil-org-mode-hook
	      (lambda ()
		(evil-org-set-key-theme)))
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys))
#+END_SRC

** org-caldav

#+BEGIN_SRC emacs-lisp
  (use-package org-caldav
    :defer 15
    :config
    (setq org-caldav-url "https://posteo.de:8443/calendars/male.schmitt"
	  org-caldav-calendar-id "default"
	  org-caldav-inbox "~/org/cal.org"
	  org-caldav-files '("~/org/tickler.org")
	  org-caldav-save-directory "~/org"
	  org-icalendar-timezone "Europe/Berlin"
	  org-caldav-delete-calendar-entries 'ask))
#+END_SRC

** org-brain

#+begin_src emacs-lisp
  (use-package org-brain
    :defer 15
    :general (my-menu-def
	       "O v" 'org-brain-visualize)
    :init
    (setq org-brain-path "~/org/brain")
    :config
    (setq org-id-track-globally t)
    (evil-set-initial-state 'org-brain-visualize-mode 'emacs)
    (setq org-id-locations-file "~/.emacs.d/.org-id-locations")
    (push '("b" "Brain" plain (function org-brain-goto-end)
	    "* %i%?" :empty-lines 1)
	  org-capture-templates)
    (setq org-brain-visualize-default-choices 'all)
    (setq org-brain-title-max-length 0))
#+end_src

* Git
** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit
    :defer 30
    :general (my-menu-def
	       "g" '(nil :which-key "git/vc")
	       "g s" 'magit-status)
    (:keymaps 'magit-mode-map
	      "SPC" nil )
    :config
    (setq magit-completing-read-function 'ivy-completing-read)
    (setq magit-diff-refine-hunk t))

  (use-package evil-magit
    :demand
    :after (evil magit))
#+END_SRC

** Forge

#+BEGIN_SRC emacs-lisp
  (use-package ghub
    :demand)

  (use-package forge
    :demand
    :after (magit ghub))
#+END_SRC

** Additional

#+BEGIN_SRC emacs-lisp
  (use-package magit-todos
    :after magit)
  ;; (use-package git-gutter-fringe+
  ;;   :ensure t
  ;;   :init (global-git-gutter-fringe+-mode)
  ;;   )
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (use-package orgit
    :after (org magit))
#+END_SRC

* Mail
** mu4e

#+begin_src emacs-lisp
  (use-package mu4e
    :defer 15
    :general (my-menu-def
	       "m" '(mu4e :which-key "mail")
	       "M" '(nil :which-key "Mail")
	       "M u" 'mu4e-update-mail-and-index)
    (:keymaps 'mu4e-main-mode-map
	      "/" 'mu4e-headers-search
	      "J" 'mu4e~headers-jump-to-maildir)
    (:keymaps 'mu4e-headers-mode-map
	      "/" 'mu4e-headers-search
	      "j" nil
	      "J" 'mu4e~headers-jump-to-maildir)

    (:keymaps 'mu4e-view-mode-map
	      "j" nil
	      "J" 'mu4e~headers-jump-to-maildir)
    :config
    (evil-make-overriding-map mu4e-main-mode-map 'normal)
    (evil-set-initial-state 'mu4e-main-mode 'normal)
    (evil-make-overriding-map mu4e-headers-mode-map 'normal)
    (evil-set-initial-state 'mu4e-headers-mode 'normal)
    (evil-make-overriding-map mu4e-view-mode-map 'normal)
    (evil-set-initial-state 'mu4e-view-mode 'normal)
    (setq mu4e-completing-read-function 'ivy-completing-read)

    ;; (setq mu4e-maildir-shortcuts
    ;; 	'( ("/posteo/Inbox" . ?p)
    ;; 	   ("/uni/Inbox" . ?u)))

    (add-hook 'mu4e-view-mode-hook 'visual-line-mode)
    (setq shr-color-visible-luminance-min 80) ;; make html background more readable

    (setq mail-user-agent 'mu4e-user-agent)
    (setq mu4e-maildir "~/.mail")
    (setq mu4e-get-mail-command "mbsync -a")
    (setq mu4e-change-filenames-when-moving t) ;; needed by mbsync
    (setq mu4e-attachment-dir  "~/dld")
    (setq mu4e-view-show-addresses 't)

    (setq message-send-mail-function 'smtpmail-send-it
	  smtpmail-default-smtp-server "posteo.de"
	  smtpmail-smtp-server "posteo.de"
	  smtpmail-stream-type 'starttls
	  smtpmail-smtp-service 587
	  smtpmail-debug-info t
	  smtpmail-debug-verbose t)

    (setq mu4e-user-mail-address-list '("male.schmitt@posteo.de" "uydvo@student.kit.edu"))
    (setq mu4e-contexts
	  `( ,(make-mu4e-context
	       :name "posteo"
	       :enter-func (lambda () (mu4e-message "Entering posteo context"))
	       :leave-func (lambda () (mu4e-message "Leaving posteo context"))
	       :match-func (lambda (msg)
			     (when msg
			       (string-match-p "^/posteo" (mu4e-message-field msg :maildir))))
	       :vars '( ( user-mail-address  . "male.schmitt@posteo.de"  )
			( user-full-name     . "Matthias Schmitt" )
			( mu4e-sent-folder   . "/posteo/Sent")
			( mu4e-drafts-folder . "/posteo/Drafts")
			( mu4e-trash-folder  . "/posteo/Trash")
			( mu4e-refile-folder . "/posteo/Archive")
			( smtpmail-smtp-server . "posteo.de"))
	       )
	     ,(make-mu4e-context
	       :name "uni"
	       :enter-func (lambda () (mu4e-message "Entering uni context"))
	       :leave-func (lambda () (mu4e-message "Leaving uni context"))
	       :match-func (lambda (msg)
			     (when msg
			       (string-match-p "^/uni" (mu4e-message-field msg :maildir))))
	       :vars '( ( user-mail-address  . "uydvo@student.kit.edu"  )
			( user-full-name     . "Matthias Schmitt" )
			( mu4e-sent-folder   . "/uni/Sent")
			( mu4e-drafts-folder . "/uni/Drafts")
			( mu4e-trash-folder  . "/uni/Trash")
			( mu4e-refile-folder . "/uni/Archives")
			( smtpmail-smtp-server . "smtp.kit.edu"))
	       )))
    (setq mu4e-context-policy 'ask-if-none)
    (setq mu4e-compose-context-policy 'ask)
    (setq message-kill-buffer-on-exit t)

    (setq mu4e-index-cleanup nil      ;; don't do a full cleanup check
	  mu4e-index-lazy-check t)    ;; don't consider up-to-date dirs
    )
#+end_src

** Additional mu4e packages

#+begin_src emacs-lisp
  ;; (use-package org-mu4e
  ;;   :after mu4e)

  (use-package mu4e-maildirs-extension
    :after mu4e
    :config
    (mu4e-maildirs-extension))

  (use-package mu4e-alert
    :after mu4e
    :config
    (mu4e-alert-set-default-style 'libnotify)
    (mu4e-alert-enable-notifications))

  (use-package mu4e-conversation
    :after mu4e
    :config
    (global-mu4e-conversation-mode))

#+end_src

* Visual
** Font

#+BEGIN_SRC emacs-lisp
  (add-to-list 'default-frame-alist '(font . "Hack-12"))
#+END_SRC

** Theme

#+BEGIN_SRC emacs-lisp
  (load-theme 'wombat t)
  ;; (disable-theme 'doom-nord)
  ;; (setq frame-background-mode nil)
  ;; (setq frame-background-mode 'dark)
  ;; (mapc 'frame-set-background-mode (frame-list))

#+END_SRC

** Modeline

#+BEGIN_SRC emacs-lisp
  (use-package minions
    :demand
    :config (minions-mode 1))

  (use-package moody
    :demand
    :config
    (setq x-underline-at-descent-line t)
    (moody-replace-mode-line-buffer-identification)
    (moody-replace-vc-mode))
#+END_SRC
** Fringe

#+BEGIN_SRC emacs-lisp
  (setq indicate-buffer-boundaries 'left)
#+END_SRC

** Scale

this or https://github.com/purcell/default-text-scale/blob/master/default-text-scale.el

#+begin_src emacs-lisp
  (defcustom default-text-scale-amount 10
    "Increment by which to adjust the :height of the default face."
    :type 'integer)

  (defun default-text-scale-increase ()
    "Increase the height of the default face by `default-text-scale-amount'."
    (interactive)
    (set-face-attribute 'default nil :height (+ (face-attribute 'default :height) default-text-scale-amount)))

  (defun default-text-scale-decrease ()
    "Decrease the height of the default face by `default-text-scale-amount'."
    (interactive)
    (set-face-attribute 'default nil :height (- (face-attribute 'default :height) default-text-scale-amount)))

  (defvar default-text-scale-pre (face-attribute 'default :height))

  (defun default-text-scale-reset ()
    "Reset the height of the default face."
    (interactive)
    (set-face-attribute 'default nil :height default-text-scale-pre))
#+end_src

*** Hydra

#+BEGIN_SRC emacs-lisp
  (defhydra hydra-zoom ()
    "
^Frame zooming^       ^Buffer scaling^
_+_: zoom in        _i_: scale in
_-_: zoom out       _d_: scale out
_=_: zoom reset     _r_: scale reset
"
    ("+" default-text-scale-increase nil)
    ("-" default-text-scale-decrease nil)
    ("=" default-text-scale-reset nil)
    ("i" text-scale-increase nil)
    ("d" text-scale-decrease nil)
    ("r" (text-scale-increase 0) nil))

  (my-menu-def "T z" #'hydra-zoom/body)
#+END_SRC

** Scrolling

** Other

Turn off mouse interface early in startup to avoid momentary display.

#+BEGIN_SRC emacs-lisp
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (tooltip-mode -1)
#+END_SRC

Highlight trailing whitespace

#+BEGIN_SRC emacs-lisp
  (setq show-trailing-whitespace t)
#+END_SRC

Highlight delimiters such as parentheses, brackets or braces according to their depth

#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :defer 15
    :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

Display line numbers in programming modes

#+BEGIN_SRC emacs-lisp
(add-hook 'prog-mode 'display-line-numbers-mode)

#+END_SRC

Display '~' on empty lines like in vi (only in programming modes)

#+BEGIN_SRC emacs-lisp
  (use-package vi-tilde-fringe
    :defer 15
    :hook (prog-mode . vi-tilde-fringe-mode))
#+END_SRC

* Completion

https://company-mode.github.io/

https://www.gnu.org/software/emacs/manual/html_node/elisp/Completion-in-Buffers.html

** Snippets

#+BEGIN_SRC emacs-lisp
  (use-package yasnippet
    :defer 15
    :diminish yas-minor-mode
    :config (yas-global-mode 1))

  (use-package yasnippet-snippets
    :after yasnippet
    :config (yasnippet-snippets-initialize))

  (use-package auto-yasnippet
    :after yasnippet
    :config (setq aya-case-fold t))
#+END_SRC

** Company

#+BEGIN_SRC emacs-lisp
  (use-package company
    :defer 30)

  (use-package company-prescient
    :after (company))

  (use-package pos-tip
    :defer 30)

  (use-package company-quickhelp
    :after (company pos-tip)
    :config (company-quickhelp-mode))
#+END_SRC

** Tags

#+begin_src emacs-lisp
  (use-package counsel-etags
    :general
    (my-menu-def
      "t" '(counsel-etags-find-tag-at-point :which-key "etags"))
    :config
    ;; counsel-etags-ignore-directories does NOT support wildcast
    (add-to-list 'counsel-etags-ignore-directories "build_clang")
    (add-to-list 'counsel-etags-ignore-directories "build_clang")
    ;; counsel-etags-ignore-filenames supports wildcast
    (add-to-list 'counsel-etags-ignore-filenames "TAGS")
    (add-to-list 'counsel-etags-ignore-filenames "*.json"))
#+end_src

** Flycheck

#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :defer 30
    :general (my-menu-def
	       "e" '(:ignore t :which-key "Errors")
	       "e e" 'flycheck-buffer
	       "e b" 'flycheck-buffer
	       "e c" 'flycheck-compile
	       "e n" 'flycheck-next-error
	       "e p" 'flycheck-prev-error))

#+END_SRC

** LSP

#+BEGIN_SRC emacs-lisp
  (use-package lsp-mode
    ;; :disabled
    ;; :hook (prog-mode . lsp)
    :commands lsp)

  (use-package lsp-ui
    :after (lsp-mode)
    :commands lsp-ui-mode)

  (use-package company-lsp
    :after (company lsp-mode)
    :commands company-lsp
    :config (push 'company-lsp company-backends))
#+END_SRC

** Spelling

#+BEGIN_SRC emacs-lisp
  (cond
   ((executable-find "aspell")
    ;; you may also need `ispell-extra-args'
    (setq ispell-program-name "aspell")
    ;; (setq-default ispell-local-dictionary "en_US" "de_DE")
    (setq-default ispell-local-dictionary "en_US")
    (setq ispell-list-command "--list"))
   ((executable-find "hunspell")
    (setq ispell-program-name "hunspell")

    ;; Please note that `ispell-local-dictionary` itself will be passed to hunspell cli with "-d"
    ;; it's also used as the key to lookup ispell-local-dictionary-alist
    ;; if we use different dictionary
    (setq-default ispell-local-dictionary "en_US")
    (setq ispell-local-dictionary-alist
	  '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8))))
   (t (setq ispell-program-name nil)))


  (use-package flyspell
    :config
    ;; ommit error messages on spell checking for performance sake
    (setq flyspell-issue-message-flag nil))

#+End_SRC

* TODO Semantic

#+BEGIN_SRC emacs-lisp
  (use-package srefactor
    :defer
    ;;:general
  )
#+END_SRC

* Modes
** dired

#+BEGIN_SRC emacs-lisp
  (general-define-key
   :keymaps 'dired-mode-map
   "SPC" nil)
#+END_SRC

** info

#+BEGIN_SRC emacs-lisp
  (general-define-key
   :keymaps 'Info-mode-map
   "SPC" nil
   "TAB" 'Info-next-reference-or-link
   "S-TAB" 'Info-prev-reference-or-link
   "C-o" 'Info-history-back
   "C-i" 'Info-history-forward
   "C-]" 'Info-follow-nearest-node

   "h" nil
   "l" nil
   "M-h" 'Info-help

   "u" 'Info-up
   "g" nil
   "gj" 'Info-next
   "gk" 'Info-prev
   "gg" 'evil-goto-first-line

   "q" 'Info-exit)

  (evil-make-overriding-map Info-mode-map 'motion)
#+END_SRC

** help

#+BEGIN_SRC emacs-lisp
  (general-define-key
   :keymaps 'help-mode-map
   "SPC" nil

   "C-o" 'help-go-back
   "C-i" 'help-go-forward
   "<" 'help-go-back
   ">" 'help-go-forward
   "r" 'help-follow

   "q" 'quit-window)
#+END_SRC

** TODO view
   [[info:emacs#View%20Mode][info:emacs#View Mode]]
   SPC and S-SPC are bound to scrolling intentionally disable anyway?
   Which buffer are in view mode?

** message

#+begin_src emacs-lisp
    (general-define-key
    :keymaps 'message-mode-map
    "q" 'bury-window)
#+end_src

** shell

#+BEGIN_SRC elisp
  ;; (use-package eshell
  ;;   :general (:keymaps 'eshell-mode-map
  ;; 		     "TAB" 'completion-at-point)
  ;;   )

  (defun setup-eshell ()
    ;; (define-key eshell-mode-map [remap eshell-pcomplete] 'completion-at-point)
    (general-define-key :keymaps 'eshell-mode-map
			[remap eshell-pcomplete] 'completion-at-point
			"C-r" 'counsel-esh-history))

  (add-hook 'eshell-mode-hook 'setup-eshell)

  (use-package eshell-prompt-extras
    :config
    (eshell-prompt-function 'epe-theme-lambda)
    )

  (use-package esh-autosuggest
    :hook (eshell-mode . esh-autosuggest-mode)
    :general (:keymaps 'esh-autosuggest-active-map
		       "C-e" 'company-complete-selection
		       "M-e" 'esh-autosuggest-complete-word))
#+END_SRC

** irc

#+BEGIN_SRC emacs-lisp
  (use-package erc
    :commands (erc erc-tls)
    )

  (setq my-fav-irc '("irc.freenode.net"
		     "irc.oftc.net"
		     "irc.mozilla.org"
		     "irc.gnome.org"))
#+END_SRC
* Programming languages
** C++
https://github.com/realgud/realgud
https://github.com/tuhdo/semantic-refactor

#+BEGIN_SRC emacs-lisp

  (use-package cc-mode
    :general (my-menu-def
	       "F o" 'ff-get-other-file))

  (use-package ccls
    :after projectile
    ;; :ensure-system-package ccls
    :custom
    (ccls-args nil)
    (ccls-executable (executable-find "ccls"))
    :init
    (setq projectile-project-root-files-top-down-recurring
	  (append '("compile_commands.json" ".ccls")
		  projectile-project-root-files-top-down-recurring))
    :config
    (setq lsp-prefer-flymake nil)
    (push ".ccls-cache" projectile-globally-ignored-directories)
    (setq-default flycheck-disabled-checkers '(c/c++-clang c/c++-cppcheck c/c++-gcc)))

  (use-package realgud
    :defer
    :after (cc-mode))

  (use-package glsl-mode
    :defer
    :mode ("\\.glsm\\'" "\\.vert\\'" "\\.frag\\'" "\\.geom\\'")
    )

  (use-package company-c-headers
    :after (cc-mode)
    :config
    (add-to-list 'company-backends 'company-c-headers)
    ;; (setq company-c-headers-path-system "" )
    )

  (setq tab-width 8) ; or any other preferred value
  ;; (defvaralias 'c-basic-offset 'tab-width)
  (setq-default c-basic-offset 8)

#+END_SRC

** Haskell
https://commercialhaskell.github.io/intero/

#+BEGIN_SRC emacs-lisp

  (use-package haskell-mode
    :defer t
    :general (:keymaps 'haskell-mode-map
		       "C-c C-c" 'haskell-compile)
    )

  (use-package intero
    :hook (haskell-mode . intero-mode)
    )


  ;; (use-package haskell-process
  ;;   :after haskell-mode)

  ;; (use-package haskell-interactive-mode
  ;;   :after haskell-mode
  ;;   :contig (add-hook 'haskell-mode-hook 'interactive-haskell-mode))


#+END_SRC

** TODO Pdf/Latex

#+BEGIN_SRC emacs-lisp
  (use-package auctex
    :defer t
    :hook (latex-mode)
    :config (progn
	      (setq TeX-parse-self t) ;; enable parse on load
	      (setq TeX-auto-safe t) ;; enable parse on safe
	      (setq TeX-safe-query nil)
	      (setq-default TeX-master nil)
	      (setq TeX-PDF-mode t)
	      (add-hook 'TeX-mode-hook 'flyspell-mode)))
  ;;
  ;;(use-package auctex-latexmk
    ;;:after (auctex)
    ;;:config (progn
	      ;;(auctex-latexmk-setup)
	      ;;(setq auctex-latexmk-inherit-TeX-PDF-mode t)))

  ;; (use-package latex-preview-pane
  ;;   :defer t)
#+END_SRC

*** pdf-tools

#+begin_src emacs-lisp
  (use-package pdf-tools
    ;; manually update
    ;; :pin manual
    ;; :general (:keymaps pdf-view-mode-map
    ;;		     "C-s" 'isearch-forward)
    :config
    (pdf-tools-install)
    ;; open pdfs scaled to fit page
    (setq-default pdf-view-display-size 'fit-page)
    ;; automatically annotate highlights
    (setq pdf-annot-activate-created-annotations t))
#+end_src

** Rust

#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :mode "\\.rs\\'"
    :config
    (push "target" projectile-globally-ignored-directories))
#+END_SRC

** Elm

#+begin_src emacs-lisp
  (use-package elm-mode
    :mode ("\\.elm\\'")
    :config
    (add-to-list 'company-backends 'company-elm)
    (push "elm-stuff" projectile-globally-ignored-directories))
#+end_src

** Markup & Config Langs

#+begin_src emacs-lisp
  (use-package yaml-mode
    :mode ("\\.yml\\'"))

  (use-package toml-mode
    :mode ("\\.toml\\'"))

  (use-package systemd)

  (use-package nginx-mode
    :init
    (add-to-list 'auto-mode-alist '("/nginx/sites-\\(?:available\\|enabled\\)/" . nginx-mode)))
#+end_src

** Config

When compiling follow the buffer
TODO even better? got to bottom on error

#+BEGIN_SRC emacs-lisp
(add-hook 'compilation-mode 'follow-mode)
#+END_SRC

* Misc
** Packages
*** Helpful

#+BEGIN_SRC emacs-lisp
  (use-package helpful
    :demand
    :general (my-menu-def
		      "h" '(helpful-at-point :which-key "help")
		      "H" '(:ignore t :which-key "Help")
		      "H h" 'helpful-symbol
		      "H v" 'helpful-variable
		      "H f" 'helpful-callable
		      "H k" 'helpful-key
		      "H X" 'helpful-kill-buffers)
    :config
    (general-define-key
     :keymaps 'helpful-mode-map
     "SPC" nil
     "n" nil
     "p" nil
     "g" nil
     "g r" 'helpful-update
     "q" 'quit-window)
    (evil-make-overriding-map helpful-mode-map 'normal)

    (setq counsel-describe-function-function #'helpful-callable)
    (setq counsel-describe-variable-function #'helpful-variable)
    )

#+END_SRC

*** ediff

#+begin_src emacs-lisp
  (use-package ediff
      :defer t
      :after (winner outline)
      :init
      (setq ediff-window-setup-function 'ediff-setup-windows-plain)
      (setq ediff-split-window-function 'split-window-horizontally)
      (setq ediff-merge-split-window-function 'split-window-horizontally)
      :config
      ;; show org ediffs unfolded
      (add-hook 'ediff-prepare-buffer-hook #'outline-show-all)
      ;; restore window layout when done
      (add-hook 'ediff-quit-hook #'winner-undo))
#+end_src

*** Indent

#+BEGIN_SRC emacs-lisp
  (use-package clean-aindent-mode
    :config (setq clean-aindent-is-simple-indent t))
#+END_SRC

** Settings
#+begin_src emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+end_src
*** follow symlinks

Always follow symlinks to vc controlled sources.
This happens a lot because my dotfiles are linked by stow.
#+BEGIN_SRC emacs-lisp
  (setq vc-follow-symlinks t)
#+END_SRC

*** PKGBUILD

Recognize arch linux pgkbuild files
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("PKGBUILD\\'" . shell-script-mode))
#+END_SRC

** Functions

#+BEGIN_SRC emacs-lisp
  (defun rename-current-file ()
    "Renames both current buffer and the file it's visiting."
    (interactive
     (progn
       (if (not (buffer-file-name))
	   (error "Buffer '%s' is not visiting a file!" (buffer-name)))
       (let ((new-file-name (read-file-name "Rename current file to: " (file-name-directory buffer-file-name)))
	     )
	 (message "Current file renamed to %s." new-file-name)
	 (rename-file buffer-file-name new-file-name)
	 (rename-buffer new-file-name)
	 (set-visited-file-name new-file-name)
	 (set-buffer-modified-p nil)
	 (setq default-directory (file-name-directory new-file-name))
	 ))))

  (defun delete-current-file ()
    "Deletes the current buffer and the file it's visiting."
    (interactive
     (progn
       (if (not (buffer-file-name))
	   (error "Buffer '%s' is not visiting a file!" (buffer-name)))
       (delete-file buffer-file-name)
       (kill-buffer)
       )))
#+END_SRC

#+BEGIN_SRC emacs-lisp
    ;; alternative command version
    (defun my-norm@q ()
      "Apply macro in q register on selected lines."
      (interactive)
      (evil-ex-normal (region-beginning) (region-end) "@q"))

  (defun reload-dir-locals-for-current-buffer ()
    "reload dir locals for the current buffer"
    (interactive)
    (let ((enable-local-variables :all))
      (hack-dir-local-variables-non-file-buffer)))

    ;; (general-define-key
    ;;  :states '(visual global)
    ;;  "Q" 'my-norm@q)
#+END_SRC

* End
The End
